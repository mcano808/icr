<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="iport" href="../../../bower_components/neon-animation/neon-animatable.html">
<link rel="import" href="../../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../iif-job-configuration/iif-job-configuration.html">
<link rel="import" href="../iif-cron-scheduler/iif-cron-scheduler.html">
<link rel="import" href="../icr-ingest-field-definition/icr-ingest-field-definition-list.html">

<!--  For use on Mock Data only-->
<link rel="import" href="../../../mock_data/mock-service.html">
<dom-module id="icr-ingest-job-builder">
  <template>
    <style include="iron-flex iron-flex-factors iron-positioning">
      :host {
        display: block;
        --paper-item-selected:{
            background-color:var(--app-secondary-color);
        }
      }
      .small{
        --iron-icon-height:16px;
        --iron-icon-wodth:16px;
      }
      #processMap{
      }
      #processSteps{
        height: 100%;
      }
      #bottomBar{
        position: absolute;
        bottom: 0;
      }
      #tryAgain{
        color: red;
        font-weight:bolder;
      }
      .item{
        cursor: pointer;
      }
      .labelInfo{
        font-style: italic;
        color: steelblue;
      }
    </style>
    <!--  Data Componenets  -->
    <mock-service jobs="{{jobTemplates}}"></mock-service>
    <div class="vertical layout fit">
      <paper-scroll-header-panel condenses class="flex">
        <paper-toolbar>
          <div>IIF</div>
          <div class="flex">
            <paper-tabs fit-container selected="{{currentProcesStep}}" autoselect>
              <paper-tab>Job Config - <span class="labelInfo">{{selectedTemplate.name}}</span></paper-tab>
              <paper-tab>Attribute Fields <span class="labelInfo">( {{selectedTemplate.attributeMappings.length}} )</span></paper-tab>
              <paper-tab>Data Persistance</paper-tab>
            </paper-tabs>
          </div>
        </paper-toolbar>
        <!-- <div>Page content</div> -->
        <div class="horizontal layout flex">
          <neon-animated-pages
            class="flex"
            selected="[[currentProcesStep]]"
            entry-animation="slide-from-right-animation"
            exit-animation="slide-left-animation">
            <!--  Template Selection Page  -->
            <neon-animatable>
              <!--  Warning when no template available -->
              <template is="dom-if" if="{{ingestJobsFailed}}" restamp="true">
                <div class="vertical layout center flex-2">
                  <h3> There are no templates available </h3>
                  <paper-button id="tryAgain" on-tap="_getTemplatesAgain">Try Again</paper-button>
                </div>
              </template>
              <div class="horizontal layout flex">
                <div class="vertical layout">
                  <!--  Template selection-->
                  <paper-listbox selected="{{selectedTemplateIdx}}">
                    <template is="dom-repeat" items="{{jobTemplates}}" index-as="index">
                      <paper-item class="item">
                        <paper-item-body two-line>
                          <div>{{item.name}}</div>
                          <div secondary>{{item.description}}</div>
                        </paper-item-body>
                      </paper-item>
                    </template>
                  </paper-listbox>
                </div>
                <div class="vertical layout flex">
                  <!--  Configuration control-->
                  <paper-tabs selected="{{configurationSelection}}" autoselect>
                    <paper-tab>Configuration</paper-tab>
                    <paper-tab>Scheduling</paper-tab>
                  </paper-tabs>
                  <iron-pages selected="{{configurationSelection}}">
                    <section>
                      <icr-ingest-job-configure
                      id="config"
                      class="flex"
                      selected-template="{{selectedTemplate}}"
                      ></icr-ingest-job-configure>
                    </section>
                    <section>
                      <iif-cron-scheduler
                        schedule="{{schedule}}"
                        valid="{{scheduleValid}}"></iif-cron-scheduler>
                    </section>
                  </iron-pages>
                </div>
              </div>
            </neon-animatable>
            <!-- Attribute Mapping Page -->
            <neon-animatable >
              <div class="vertical layout flex">
                <template is="dom-if" if="{{listHasErrors}}" restamp="true">
                  <div class="horizontal layout flex">
                    <p>Errors here</p>
                  </div>
                </template>
                <paper-input label="Name..." value="{{jobName}}" class="flex"></paper-input>
                <paper-input label="Description..." value="{{jobDescription}}" class="flex"></paper-input>
                <paper-button raised>Load Sample</paper-button>
                <icr-ingest-field-definition-list
                  class="flex"
                  attribute-mappings="{{selectedTemplate.attributeMappings}}"
                  errors="{{listErrors}}"
                  has-errors="{{listHasErrors}}"></icr-ingest-field-definition-list>
              </div>
            </neon-animatable>
            <!--  Persistance Config Page-->
            <neon-animatable>
              Persistance stuff will go here.
            </neon-animatable>
          </neon-animated-pages>
        </div>
      </paper-scroll-header-panel>
    </div>
    <!--  BUG This is styled to sit at the bottom but doesn't move when addition attribute rows are added because it's absolute position-->
    <div id="bottomBar" class="horizontal layout flex">
      <paper-button id="nextProcessStep" class="flex" on-tap="nextProcessStep" raised>Next Step</paper-button>
      <paper-button raised on-tap="submitJob">Submit</paper-button>
    </div>
  </template>
  <script>
    Polymer({
      is: 'icr-ingest-job-builder',
      properties:{
        jobTemplates:{
          type:Array
        },
        jobName:{
          type: String
        },
        listErrors:{
          type:Array,
          notify: true,
          value:()=>{return []}
        },
        listHasErrors:{
          type: Boolean
        },
        selectedTemplateIdx:{
          type: Number,
          observer:"_selectedTemplateIndexChanged"
        },
        selectedTemplate:{
          type:Object,
          notify: true
        },
        configurationSelection:{
          type: Number,
          value: 0,
          notify: true
        },
        currentProcesStep:{
          type: Number,
          value:0,
          notify: true
        },
        schedule:{
          type: Object,
          notify: true
        },
        scheduleValid:{
          type: Boolean
        }
      },
      observers:[],
      _getTemplatesAgain(){
        this.$.serviceJobs.getJobs();
      },
      nextProcessStep(){
        const totalSteps = 3;
        if(this.currentProcesStep < totalSteps -1){
          this.set('currentProcesStep', this.currentProcesStep +1)
        }else{
          this.set('currentProcesStep', 0);
        }
      },
      _selectedTemplateIndexChanged(newIdx, oldIdx){
        this.set('selectedTemplate',this.jobTemplates[newIdx]);
        //this.currentProcesStep = 1;
      },
      _templateSelected(event){
        this.selectedTemplate = event.model;
      },
      submitJob(){
        let submitObject = {
          name:this.jobName,
          jobProperties:this.selectedTemplate.jobProperties,
          attributeMappings:this.selectedTemplate.attributeMappings
        };

        console.info('The final product: ', submitObject);
        //TODO send the submitObject back to a service someplace.
      }
    });
  </script>
</dom-module>
