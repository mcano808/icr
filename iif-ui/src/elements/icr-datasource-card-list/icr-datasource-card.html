<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../elements/icr-nice-time/icr-nice-time.html">
<link rel="import" href="../../shared-styles.html">
<dom-module id="icr-datasource-card">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      :host {
        display: inline-block;
        margin: 12px;
        border: 1px solid black;
      }
      .content{
        padding: 4px 8px;
      }
      .body:{
        padding-top: 4px;
        padding-bottom: 4px;
      }
      .footer{
        border-top: 1px solid lightgrey;
        padding-top: 4px;
      }
      .status{
        height:100px;
        width:100%;
        border-radius: 0;
      }
      .status.small{
        width:1.15em;
        height:1.15em;
      }
      .heading{
        padding: 25px 10px;
        font-weight: bolder;
        font-size: 1.25em;
      }
    </style>

    <div class="container vertical layout">
      <div class$="status {{_itemStatus}}"></div>
      <div class="heading">{{item.dsName}}</div>
      <div class="content flex">
        <div class="body flex">
          <div id="runTime">Last Run: <icr-nice-time time-in="{{_lastRun.date}}"></icr-nice-time></div>
          <div id="runLength">Run Time: {{_lastRun.duration}}</div>
          <paper-tooltip for="runTime">Stamp: {{_lastRun.date}}</paper-tooltip>
        </div>
        <div class="footer horizontal layout">
          <paper-icon-button icon="create" on-tap="editIngestJob"></paper-icon-button>

        </div>
      </div>

    </div>
  </template>

  <script>
    Polymer({
      is: 'icr-datasource-card',
      properties:{
        item:{
          type:Object,
          value:()=>{return {}},
          observer:'_itemChanged'
        },
        _itemStatus:{
          type:String,
          computed:'computeItemStatus(item)'
        },
        _lastRun:{
          type:Object,
          computed:'computeLastRun(item)'
        }
      },
      _itemChanged(newItem, oldItem){
        console.log('item changed in card: ', arguments);
      },
      computeItemStatus(item){
        console.log('computing item status: ', item);
        let itemRuns = item.runs;
        //TODO Sort runs with newest time first
        if(itemRuns === undefined ||itemRuns.length < 1) return 'bad';
        let lastRun = itemRuns[0];
        switch (lastRun.status.toLowerCase()) {
          case 'new':
          case 'new_saving':
          case 'submitted':
          case 'accepted':
            return 'warn'
            break;
          case 'running':
          case 'finished':
            return 'ok';
            break;
          case 'failed':
          case 'killed':
            return 'bad';
            break;
        }
      },
      computeLastRun(item){
        //only update if the item hass runs
        if(item.runs && item.runs.length > 0){
          let runs = item.runs;
          //Sort the array by date with most recent first
          runs.sort(function(a, b){
            return new Date (a.date) - new Date (b.date);
          });
          console.log('sorted runs arraya by date:', runs);
          return runs[0];
        }else{
          //TODO What to return if no runs?
          return null;
        }
      },
      editIngestJob(event, detail){
        console.info('Edit inget job now');
        //fire event for others to listen to.
        this.fire('icr-edit-job', { });

      }
    });
  </script>
</dom-module>
