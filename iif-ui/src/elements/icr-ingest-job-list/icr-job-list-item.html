<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../icr-nice-time/icr-nice-time.html">
<link rel="import" href="../../shared-styles.html">
<dom-module id="icr-job-list-item">
  <template>
    <style include="shared-styles iron-flex iron-flex-layout">
      :host {
        display: block;
      }
      paper-progress{
        width:40px;
        margin-right: 10px;
      }
      .info{
        margin: 0 5px;
      }
      .status{
        margin-right:10px;
      }
    </style>
    <paper-item class="layout horizontal">
      <div id="status" class$="status small {{lineStatus}}"></div>
      <paper-tooltip for="status">Status: {{lineItem.state}}</paper-tooltip>
      <template is="dom-if" if="{{!isFinished}}">
        <!-- Show how long it took -->
        <paper-progress id="lineProgress" value="{{lineItem.progress}}"></paper-progress>
        <paper-tooltip for="lineProgress">{{lineItem.progress}} % Progress</paper-tooltip>
      </template>
      <span id="startedTime" class="info"><icr-nice-time time-in="{{lineItem.startedTime}}"></icr-nice-time></span>
        <paper-tooltip for="startedTime">Start Time</paper-tooltip>
      <template is="dom-if" if="{{isFinished}" restamp="true">
        <!-- Show how long the job took -->
        <span id="jobLength" class="info">{{jobLength}}</span>
        <paper-tooltip for="jobLength">Run Time</paper-tooltip>
      </template>
      <div class="flex">{{lineItem.id}}</div>
      <paper-icon-button id="runNow" icon="av:play-circle-outline" on-click="runNow"></paper-icon-button>
      <paper-tooltip for="runNow">Run now.</paper-tooltip>
      <paper-icon-button id="editJob"icon="settings" on-click="editJobSettings"></paper-icon-button>
      <paper-tooltip for="editJob">Edit configuration.</paper-tooltip>
    </paper-item>
  </template>
  <script>
    Polymer({
      is: 'icr-job-list-item',
      properties:{
        isFinished:{
          type: Boolean,
          notify: true,
          value: false
        },
        jobLength:{
          type: String,
          computed:'computeJobLength(lineItem)'
        },
        lineItem:{
          type:Object,
          notify: true,
          value:()=>{return {};}
        },
        lineStatus:{
          type:String,
          value:'',
          notify: true
        }
      },
      observers:[
        'updateLineItemStatus(lineItem)'
      ],
      computeJobLength(lineItem){
        let factor = 1000 * 60 ;
          let time = lineItem.elapsedTime / factor;
          console.log("time:", time);
          return time.toFixed(1) + " min";
      },
      editJobSettings(){
        console.log("edit job settins: ", this.lineItem);
      },
      jobLength:{
        type:String,
        computed:'computeJobLength(lineItem)'
      },
      runNow(){
        console.log('running job now: ', this.lineItem);
      },
      updateLineItemStatus(lineItem){
        console.log('about to update status based on: ', lineItem);
        switch (lineItem.state.toLowerCase()) {
          case 'new':
          case 'new_saving':
          case 'submitted':
          case 'accepted':
            this.lineStatus = 'warn';
            this.isFinished = false;
            break;
          case 'running':
            this.lineStatus = 'info';
            this.isFinished = false;
            break;
          case 'finished':
            this.lineStatus = "info";
            this.isFinished = true;
            break;
            case 'failed':
            case 'killed':
              this.lineStatus = 'bad';
              this.isFinished = true;
              break;
        }
      }
    });
  </script>
</dom-module>
