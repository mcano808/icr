<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../icr-error-display/icr-error-display.html">
<link rel="import" href="../poly-moment/poly-moment.html">
<link rel="import" href="../../shared-styles.html">

<dom-module id="icr-ingest-server-status">
  <template>
    <style include="shared-styles">
      :host{
        display: block;
        position: relative;
      }
      .section {
        padding: 0 4px;
      }
      .status{
        display: inline-block;
        box-sizing: border-box;
        width:40px;
        height: 40px;
        border-radius: 50%;
      }
    </style>

      <h4>Server Status</h4>
    <!-- Force Resample Button -->
    <!-- In case where any ONE of the services are getting errors -->
    <icr-error-display
      has-error="{{serviceErrors}}"
      show-error-message
      error-message="One or more services are down"></icr-error-display>
    <!-- List of data -->
    <template is="dom-if" if="{{!serviceErrors}}" restamp="true">
      <div role="listbox">
        <paper-icon-item>
          <div class$="status {{statusColor}}" item-icon></div>
          <paper-item-body two-line>
            <div><b>ID</b> - {{clusterInfo.clusterInfo.id}}</div>
            <div secondary>Started {{getNiceTime(clusterInfo.clusterInfo.startedOn)}}</div>
          </paper-item-body>
          <paper-icon-button icon="refresh" on-click="resampleNow"></paper-icon-button>
        </paper-icon-item>
        <paper-item>
          <paper-item-body two-line>
            <div><b>Nodes</b></div>
            <div secondary>
              <span class="section">Active : {{clusterMetrics.clusterMetrics.activeNodes}}</span>
              <span class="section">Total: {{clusterMetrics.clusterMetrics.totalNodes}}</span>
              <b> | </b>
              <span class="section">Lost: {{clusterMetrics.clusterMetrics.lostNodes}}</span>
              <span class="section">Unhealthy: {{clusterMetrics.clusterMetrics.unhealthyNodes}}</span>
              <span class="section">Decommisioned: {{clusterMetrics.clusterMetrics.decommissionedNodes}}</span>
              <span class="section">Rebooted: {{clusterMetrics.clusterMetrics.rebootedNodes}}</span>
            </div>
          </paper-item-body>
        </paper-item>
        <paper-item>
          <paper-item-body two-line>
            <div><b>Jobs</b></div>
            <div secondary>
              <span class="section">Submitted: {{clusterMetrics.clusterMetrics.appsSubmitted}}</span>
              <span class="section">Completed: {{clusterMetrics.clusterMetrics.appsCompleted}}</span>
              <b> |</b>
              <span class="section">Pending: {{clusterMetrics.clusterMetrics.appsPending}}</span>
              <span class="section">Running: {{clusterMetrics.clusterMetrics.appsRunning}}</span>
              <b> |</b>
              <span class="section"> Failed: {{clusterMetrics.clusterMetrics.appsFailed}}</span>
              <span class="section"> killed: {{clusterMetrics.clusterMetrics.appsKilled}}</span>
            </div>
          </paper-item-body>
         </paper-item>
         <paper-item>
           <paper-item-body two-line>
             <div><b>Space(mb)</b></div>
             <div secondary>
               <span class="section">Available: {{clusterMetrics.clusterMetrics.availableMB}}</span>
               <span class="section">Total: {{clusterMetrics.clusterMetrics.totalMB}}</span>
               <b> |</b>
               <span class="section">Allocated: {{clusterMetrics.clusterMetrics.allocatedMB}}</span>
               <span class="section">Reserved: {{clusterMetrics.clusterMetrics.reservedMB}}</span>
            </div>
        </paper-item>
      </div>
    </template>
  </template>

  <script>
    Polymer({
      is:'icr-ingest-server-status',
      properties:{
        clusterInfo:{
          type: Object,
          observer:'clusterInfoChanged'
        },
        clusterMetrics:{
          type:Object
        },
        infoError:{
          type: Boolean,
          notify: true,
          value: false
        },
        metricsError:{
          type: Boolean,
          notify: true,
          value: true
        },
        serviceErrors:{
          type:Boolean,
          notify: true
        },
        statusColor:{
          type:String,
          value:'ok'
        }
      },
      observers:["serviceErrorsChanged(metricsError, infoError)"],
      clusterInfoChanged(nV, oV){
        this.updateStatusColor(this.clusterInfo);
      },
      getNiceTime(rawTime){
        let time = moment(rawTime).fromNow();
        return time;
      },
      resampleNow(){
        // this.$.metricsData.resampleNow();
        // this.$.infoData.resampleNow();
      },
      serviceErrorsChanged(metricsError, infoError){
        console.log('service errors changed: ', arguments);
        if(!metricsError && !infoError){
          this.serviceErrors = false;
        }else if(metricsError || infoError){
          this.serviceErrors = true;
        }

      },
      startDataRetrieval(){
        // this.$.metricsData.start();
        // this.$.infoData.start();
      },
      stopDataRetrieval(){
        // this.$.metricsData.stop();
        // this.$.infoData.stop();
      },
      updateStatusColor(clusterInfo){
        const baseClass = "status";
        if(clusterInfo === null){
          return baseClass + 'bad';
        }else{
          switch (clusterInfo.clusterInfo.state.toLowerCase()) {
            case 'started':
              return baseClass + 'good';
              break;
            case 'failed':
                return baseClass + 'bad';
              break;
            default:
              console.warn("unknown cluster state: " + clusterInfo.clusterInfo.state);
          }
        }
      }
    });
  </script>
</dom-module>
